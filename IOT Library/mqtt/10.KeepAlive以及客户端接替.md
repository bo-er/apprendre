## 半开放式TCP连接问题


[MQTT基于传输控制协议（TCP）](./3.客户端，代理:服务器和连接建立.md)。该协议确保以[“可靠，有序和错误检查”的](http://en.wikipedia.org/wiki/Transmission_Control_Protocol)方式在互联网上传输数据包。但是，有时通信方之间的传输可能会不同步。例如，如果当事方之一崩溃或发生传输错误。在TCP中，这种不完整连接的状态称为[半开连接](http://en.wikipedia.org/wiki/TCP_half-open)。要记住的重要一点是，通信的一侧继续起作用，而没有通知另一侧发生故障。仍处于连接状态的一方将继续尝试发送消息并等待确认。

正如Andy Stanford-Clark（MQTT协议的发明者）指出的那样，半开放连接的问题在移动网络中越来越多：

> “尽管理论上TCP / IP在套接字中断时会通知您，但实际上，尤其是在移动和卫星链路之类的东西上，它们经常通过空中“伪造” TCP并在每个末端放回标头，对于TCP而言，这很有可能会话到“黑洞”，即它似乎建立了连接，但实际上只是将您写入它的所有内容都丢到了地板上。”
>
> 安迪·斯坦福·克拉克（Andy Stanford-Clark）的主题是：“为什么需要保持活力？” [来源](https://groups.google.com/forum/#!msg/mqtt/zRqd8JbY4oM/XrMwlQ5TU0EJ)

## MQTT Keep Alive

MQTT包括一个keep alive的功能，该功能为半开连接的问题提供了一种解决方法（或者至少使评估连接是否仍处于打开状态成为可能）。

**保持活动状态可确保代理和客户端之间的连接仍处于打开状态，并确保代理和客户端知道已连接。**当客户端建立与代理的连接时，客户端将以秒为单位的时间间隔传达给代理。此时间间隔定义了代理和客户端可能无法相互通信的最大时间长度。

*MQTT规范指出以下内容*：

> “保持活动...是在客户端完成发送一个控制数据包的时间点与开始发送下一个控制数据包的时间之间允许的最大时间间隔。客户端有责任确保发送的控制数据包之间的时间间隔不超过“保持活动”值。在没有发送任何其他控制数据包的情况下，客户端必须发送PINGREQ数据包。

**只要频繁交换消息且不超过保持连接间隔，就无需发送额外的消息来确定连接是否仍处于打开状态。**

如果客户端在保持活动期间未发送消息，则必须将PINGREQ数据包发送给代理，以确认该消息可用，并确保代理也仍然可用。

**代理必须在保持活动间隔的一半半之内断开不发送消息或PINGREQ数据包的客户端的连接。**同样，如果客户端在合理的时间内未收到代理的响应，则期望该客户端关闭连接。

### Keep Alive Flow

让我们仔细看看保持活动消息。保持活动功能使用两个数据包：

#### PINGREQ

![平雷克](../pictures/pingreq.png)

PINGREQ由客户端发送，并向代理指示客户端仍然有效。如果客户端未发送任何其他类型的数据包（例如，PUBLISH或SUBSCRIBE数据包），则客户端必须将PINGREQ数据包发送到代理。客户端可以在想要确认网络连接仍处于活动状态的任何时间发送PINGREQ数据包。PINGREQ数据包不包含有效载荷。

#### PINGREQ

![PINGREQ](https://www.hivemq.com/img/blog/pingresp.png)

当代理接收到PINGREQ数据包时，代理必须以PINGRESP数据包答复以向客户端显示它仍然可用。PINGRESP数据包也不包含有效载荷。

### PINGRESP

- 如果代理未从客户端收到PINGREQ或任何其他数据包，则代理将关闭连接并发送[最后的遗嘱消息](https://www.hivemq.com/blog/mqtt-essentials-part-9-last-will-and-testament/)（如果客户端指定了LWT）。
- 它是有责任[MQTT客户端](https://www.hivemq.com/blog/seven-best-mqtt-client-tools/)设置适当保持活动的价值。例如，客户端可以将保持活动间隔调整为其当前信号强度。
- 最长存活时间为18小时12分15秒。
- 如果保持活动间隔为0，则保持活动机制将被停用。

## 客户接管

通常，断开连接的客户端会尝试重新连接。有时，代理仍然为客户端提供半开放连接。在MQTT中，如果代理检测到半开连接，它将执行“客户端接管”。**代理关闭与相同客户端的先前连接（由客户端标识符确定），并与客户端建立新连接。**此行为可确保半开连接不会阻止断开连接的客户端重新建立连接。