## 保留邮件

**保留消息是将保留标志设置为 true 的常规 MQTT 消息。代理存储该主题的最后保留的消息和相应的 QoS。**订阅与保留消息的主题匹配的主题模式的每个客户端在订阅后都会立即收到保留消息。代理每个主题仅存储一条保留的消息。

如果订阅客户端在通配的主题模式中包含通配符，则即使保留消息的主题不完全匹配，它也会收到保留消息。这是一个示例：客户端 A 将保留的消息发布到 _myhome / livingroom / temperature_。稍后，客户端 B 订阅了 _myhome /＃_。客户端 B 订阅*myhome /＃*后，*立即*收到*myhome / livingroom / temp*保留的消息。客户端 B（预订客户端）可以看到该消息是保留的消息，因为代理发送的保留消息的保留标志设置为 true。客户端可以决定如何处理保留的消息。

**保留的消息可帮助新订阅的客户端订阅主题后立即获得状态更新。保留的消息消除了等待发布客户端发送下一个更新的等待。**

换句话说，一个主题所保留的消息是最后一个已知的好值。保留的消息不必是最后一个值，但必须是保留标记设置为 true 的最后一条消息。

重要的是要了解保留的消息与[持久会话（我们上周讨论过的主题）](../7.持久性会话跟队列消息.md)无关。代理存储了保留的消息后，只有一种方法可以删除它。继续阅读以了解操作方法。

### 发送保留的消息

从开发人员的角度来看，发送保留的消息非常简单明了。将[MQTT 发布消息](../4.发布，订阅与退订.md)的`retained` 标志设置为真就可以。通常，您的客户端库提供了一种设置此标志的简便方法。

### 删除保留的消息

还有一种删除 topic 的保留消息的非常简单的方法：在要删除先前保留的消息的主题上发送带有零字节有效负载的保留消息。代理删除保留的消息，新订阅者不再获得该主题的保留的消息。通常，甚至没有必要删除，因为每个新保留的消息都会覆盖前一个。

## 为什么以及何时应该使用保留消息？

**当您希望新连接的订户立即接收消息时（无需等到发布客户端发送下一条消息时），保留消息才有意义。** 这对于个别主题的组件或设备的状态更新非常有帮助。例如，*device1*的状态位于主题*myhome / devices / device1 / status 上*。使用保留的消息时，主题的新订阅者订阅后会立即获得设备的状态（在线/离线）。对于以时间间隔，温度，GPS 坐标和其他数据发送数据的客户端，情况也是如此。**如果没有保留的消息，则新订阅者将在发布间隔之间获取不到任何信息。** 使用保留的消息有助于立即为连接的客户端提供最后的有意义值。
