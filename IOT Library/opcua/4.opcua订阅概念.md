# OPC UA 订阅概念

与永久读取信息（轮询）相比，OPC UA 提供了更为优雅的功能，即所谓的订阅。UA 客户端可以订阅感兴趣的节点，并让服务器监视这些项目。仅在发生更改（例如更改其值）的情况下，服务器才会将此类更改通知客户端。这种机制极大地减少了传输的数据量。除了减少带宽外，此机制还具有其他优点，并且是从 UA 服务器“读取”信息的推荐机制。

客户端可以订阅 OPC UA 服务器提供的不同类型的信息。订阅的目的是将称为“受监视的项目”的这些信息源组合在一起，形成一条称为“通知”的信息。

下图显示了客户端订阅数据更改和事件时涉及的服务。

订阅至少包含一个受监视的项目，必须在一个会话的上下文中创建并可以转移到另一个会话。要创建会话，必须在客户端和服务器之间建立安全通道。

![channel_session_subscription.png](/Users/steve/Documents/GIT/apprendre/IOT Library/pictures/channel_session_subscription.png)

订阅数据更改和事件所需的上下文

将“受监视的项目”添加到订阅时，客户端可以订阅三种不同类型的“更改”：

- 订阅变量值（变量的 Value 属性）的数据更改，
- 订阅对象的事件（对象和事件过滤器集的 EventNotifier 属性），
- 订阅聚合值(aggregated Values)，这些值是根据当前变量值在客户端定义的时间间隔中计算得出的。

下图显示了“受监视的项目”和“订阅”可用的设置

订阅和监视项目的设置:

![subscription_model.png](/Users/steve/Documents/GIT/apprendre/IOT Library/pictures/subscription_model.png)

采样间隔为订阅中的每个受监视项目分别定义一个时间间隔。这是服务器检查数据源是否有更改的速率。设置采样的速度可以比通知客户端的速度快得多，在这种情况下，服务器可以将采样排入队列并发布完整的队列（请参见下文）。服务器将修改最快的采样间隔，并以此“保护”数据源免受采样本身可能造成的大量负载的影响。对于“汇总监视项目”，“采样间隔”表示计算汇总的时间间隔。

筛选器包含几个标准，以区分应报告哪些数据更改或事件以及应阻止哪些数据更改或事件。对于“汇总监视项”，它还包含“原始数据采样间隔”，该间隔定义了从数据源中采样值的速率。

UA 服务器可以支持数据样本或事件的排队。可以为每个监视项目配置队列大小，即可以排队的值的最大数量。当数据传递到客户端（发布）时，队列将清空。每个队列都有一个丢弃策略（例如最旧的丢弃），以防发生溢出。

通过设置监视模式，可以启用或禁用数据采样和报告。

有两个设置会影响订阅本身。在每个发布间隔之后，队列中收集的通知将通过通知消息（发布响应）传递给客户端。客户端必须确保服务器已收到足够的发布令牌（发布请求），以便无论何时经过发布间隔并准备好发送通知，服务器都会使用该令牌并在发布响应中发送数据。如果没有要报告的内容（例如，未更改任何值），则服务器将向客户端发送一个 KeepAlive 通知，该通知为空的 Publish，以指示服务器仍处于活动状态。可以通过更改“发布已启用”设置来启用或禁用通知消息的发送。

下一章介绍[发现和安全配置](./5.服务发现以及安全配置.md)。
